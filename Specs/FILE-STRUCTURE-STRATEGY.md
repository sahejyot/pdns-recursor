# File Structure Strategy
## PowerDNS Recursor - Windows Port

**Date**: October 27, 2025  
**Strategy**: Same flat structure as original PowerDNS

---

## Core Principle

**MAINTAIN EXACT SAME FILE STRUCTURE AS ORIGINAL**

```
âŒ WRONG: Creating separate directories
pdns_recursor_windows/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ windows/
â”‚   â””â”€â”€ linux/

âœ… CORRECT: Flat structure (like original)
pdns_recursor_windows/
â”œâ”€â”€ rec-main.cc
â”œâ”€â”€ syncres.cc
â”œâ”€â”€ dnsparser.cc
â”œâ”€â”€ mplexer.hh
â”œâ”€â”€ epollmplexer.cc
â”œâ”€â”€ libeventmplexer.cc  (NEW)
â”œâ”€â”€ CMakeLists.txt      (NEW)
â””â”€â”€ ...all other files...
```

---

## File Categories

### 1. Platform-Independent Files (Copy as-is)

These files work on both Linux and Windows without changes:

```
âœ… syncres.cc/hh           - DNS resolution logic
âœ… dnsparser.cc/hh         - DNS packet parsing
âœ… dnswriter.cc/hh         - DNS packet writing
âœ… dnsname.cc/hh           - DNS name handling
âœ… recursor_cache.cc/hh    - Caching logic
âœ… negcache.cc/hh          - Negative caching
âœ… validate.cc/hh          - DNSSEC validation
âœ… qtype.cc/hh             - DNS query types
âœ… misc.cc/hh              - Utilities
âœ… mtasker.hh              - Coroutines (Boost.Context)
âœ… mtasker_context.cc      - Context switching

... and ~150+ other core files
```

**Action**: Copy these files directly, no modifications needed!

---

### 2. Files Needing #ifdef (Copy and modify)

These files need Windows-specific code added:

#### rec-main.cc (Process management)
```cpp
// BEFORE (Linux-only):
for (int i=0; i < num_processes; i++) {
    if (fork() == 0) {
        worker_main();
    }
}

// AFTER (Cross-platform):
#ifdef _WIN32
    // Windows: Use threads
    std::vector<std::thread> workers;
    for (int i=0; i < num_threads; i++) {
        workers.emplace_back(worker_main, i);
    }
#else
    // Linux: Keep fork()
    for (int i=0; i < num_processes; i++) {
        if (fork() == 0) {
            worker_main();
        }
    }
#endif
```

#### rec_channel.cc (IPC)
```cpp
// BEFORE (Unix sockets):
socket(AF_UNIX, SOCK_STREAM, 0);

// AFTER (Cross-platform):
#ifdef _WIN32
    // Windows: Use TCP localhost
    socket(AF_INET, SOCK_STREAM, 0);
    connect(sock, "127.0.0.1:8954");
#else
    // Linux: Unix socket
    socket(AF_UNIX, SOCK_STREAM, 0);
    connect(sock, "/var/run/pdns_recursor.sock");
#endif
```

#### Other files:
```
âš ï¸ rec-main.cc            - Threading/daemonization
âš ï¸ rec_channel.cc         - IPC (Unix sockets â†’ TCP)
âš ï¸ capabilities.cc        - Wrap in #ifdef __linux__
âš ï¸ unix_utility.cc        - Wrap in #ifdef __linux__
```

---

### 3. Linux-Only Files (Copy but disable on Windows)

These files are Linux-specific and won't compile on Windows:

```cpp
// epollmplexer.cc (existing)
#ifdef __linux__
// ... epoll implementation ...
#endif

// capabilities.cc (existing)
#ifdef __linux__
// ... libcap implementation ...
#endif

// devpollmplexer.cc (existing)
#ifdef HAVE_DEVPOLL
// ... Solaris /dev/poll ...
#endif
```

**Action**: Copy as-is, they already have #ifdef guards!

---

### 4. Windows-Only Files (NEW)

Create these new files at root level:

```
ğŸ†• libeventmplexer.cc     - Windows I/O multiplexer using libevent
ğŸ†• CMakeLists.txt         - Windows build system
ğŸ†• README-WINDOWS.md      - Windows-specific documentation
ğŸ†• config.h               - Generated by CMake
```

#### Example: libeventmplexer.cc
```cpp
#ifdef _WIN32
#include "mplexer.hh"
#include <event2/event.h>
#include <winsock2.h>

class LibeventMultiplexer : public FDMultiplexer {
    // Implementation using libevent for Windows
};

#endif // _WIN32
```

**Location**: Root level, same as `epollmplexer.cc`

---

## Build System Strategy

### Linux (Unchanged)
```bash
# Original autotools still works!
cd pdns-recursor/
./configure
make
```

### Windows (New CMake)
```powershell
# New CMake build
cd pdns_recursor_windows/
mkdir build && cd build
cmake .. -G "Visual Studio 17 2022"
cmake --build . --config Release
```

### CMakeLists.txt Structure
```cmake
# Flat file structure (root level)
set(CORE_SOURCES
    syncres.cc
    dnsparser.cc
    dnswriter.cc
    # ... all at root level
)

if(WIN32)
    list(APPEND PLATFORM_SOURCES libeventmplexer.cc)
elseif(UNIX)
    list(APPEND PLATFORM_SOURCES epollmplexer.cc)
endif()
```

**No src/core/ or src/windows/ directories!**

---

## File Copying Workflow

### Sprint 1: Minimal POC

```powershell
# 1. Copy core DNS files (to root)
cd pdns_recursor_windows
cp ../pdns-recursor/dnsname.cc .
cp ../pdns-recursor/dnsname.hh .
cp ../pdns-recursor/dnsparser.cc .
cp ../pdns-recursor/dnsparser.hh .
# ... etc

# 2. Create CMakeLists.txt
# (at root level)

# 3. Create libeventmplexer.cc
# (at root level, same as epollmplexer.cc)

# 4. Build
mkdir build && cd build
cmake ..
cmake --build .
```

### Sprint 2-3: Add more files

```powershell
# Copy more files as needed (all to root)
cp ../pdns-recursor/rec-main.cc .
cp ../pdns-recursor/syncres.cc .
cp ../pdns-recursor/recursor_cache.cc .

# Add #ifdef _WIN32 to files that need it
# (Edit in place, don't move to subdirectories)
```

---

## Advantages of Flat Structure

### âœ… Easy Comparison
```bash
# Compare with original easily
diff pdns-recursor/syncres.cc pdns_recursor_windows/syncres.cc
```

### âœ… Easy Updates
```bash
# Pull upstream changes easily
cp pdns-recursor/syncres.cc pdns_recursor_windows/syncres.cc
```

### âœ… Maintain Mental Model
```
Developer familiar with PowerDNS finds:
  pdns-recursor/syncres.cc
  pdns_recursor_windows/syncres.cc

Same location, same name!
```

### âœ… Linux Build Untouched
```bash
# Original Linux build still works
cd pdns-recursor/
./configure && make

# Windows build separate
cd pdns_recursor_windows/
cmake .. && cmake --build .
```

### âœ… Future Merge Friendly
```
If PowerDNS officially adds Windows support,
merging is easier because file structure matches!
```

---

## What NOT to Do

### âŒ Don't Create Subdirectories
```
# WRONG:
pdns_recursor_windows/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/syncres.cc       âŒ
â”‚   â””â”€â”€ windows/winsock.cc    âŒ

# RIGHT:
pdns_recursor_windows/
â”œâ”€â”€ syncres.cc                âœ…
â””â”€â”€ libeventmplexer.cc        âœ…
```

### âŒ Don't Rename Files
```
# WRONG:
syncres_windows.cc            âŒ
dns_parser_cross_platform.cc  âŒ

# RIGHT:
syncres.cc                    âœ…
dnsparser.cc                  âœ…
```

### âŒ Don't Separate Platform Code Unnecessarily
```cpp
// WRONG: Creating separate files
winsock_wrapper.cc            âŒ
linux_socket.cc               âŒ

// RIGHT: #ifdef in same file
#ifdef _WIN32
    // Windows code
#else
    // Linux code
#endif
```

---

## Quick Reference Table

| File Type | Location | Action |
|-----------|----------|--------|
| Platform-independent (syncres.cc) | Root | Copy as-is |
| Needs #ifdef (rec-main.cc) | Root | Copy + add #ifdef |
| Linux-only (epollmplexer.cc) | Root | Copy as-is (has #ifdef) |
| Windows-only (libeventmplexer.cc) | Root | Create new |
| Build system (CMakeLists.txt) | Root | Create new |

---

## Implementation Checklist

### Phase 1: POC
- [ ] Copy 10-15 core files to root
- [ ] Create CMakeLists.txt at root
- [ ] Create libeventmplexer.cc at root
- [ ] Build minimal DNS parser
- [ ] No subdirectories!

### Phase 2: Core DNS
- [ ] Copy 50+ more files to root
- [ ] Add #ifdef to rec-main.cc
- [ ] Add #ifdef to rec_channel.cc
- [ ] Test DNS resolution
- [ ] Still no subdirectories!

### Phase 3: Full Port
- [ ] Copy all 200+ files to root
- [ ] Add #ifdef where needed
- [ ] Test all features
- [ ] Flat structure maintained!

---

## Summary

**One Rule to Remember**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Copy files to ROOT LEVEL                           â”‚
â”‚  Same names, same locations as original             â”‚
â”‚  Use #ifdef for platform differences                â”‚
â”‚  NO subdirectories like src/core/ or src/windows/   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**When in doubt**: Look at the original `pdns-recursor/` directory. If a file is at the root there, put it at the root in `pdns_recursor_windows/` too!

---

## See Also

- [BUILD-INSTRUCTIONS.md](BUILD-INSTRUCTIONS.md) - How to build
- [TECHNICAL-ARCHITECTURE.md](TECHNICAL-ARCHITECTURE.md) - Technical design
- [IMPLEMENTATION-PLAN-SPRINTS.md](IMPLEMENTATION-PLAN-SPRINTS.md) - Sprint plan

**Remember**: Same structure = Easy maintenance! ğŸ¯


