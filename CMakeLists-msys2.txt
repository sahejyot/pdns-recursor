cmake_minimum_required(VERSION 3.20)
project(pdns-recursor-windows VERSION 5.3.0 LANGUAGES CXX)

# Set C++ standard
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Prefer Clang on Windows (GCC-compatible, works in PowerShell)
if(WIN32)
    # Try to use Clang if available (falls back to MSVC or default)
    if(CMAKE_CXX_COMPILER_ID STREQUAL "Clang")
        message(STATUS "Using Clang compiler (GCC-compatible)")
        set(COMPILER_TYPE "CLANG")
    elseif(CMAKE_CXX_COMPILER_ID STREQUAL "MSVC")
        message(STATUS "Using MSVC compiler (may need bitfield adjustments)")
        set(COMPILER_TYPE "MSVC")
    elseif(CMAKE_CXX_COMPILER_ID MATCHES "GNU")
        message(STATUS "Using MinGW/GCC compiler")
        set(COMPILER_TYPE "MINGW")
    else
        message(STATUS "Using default compiler: ${CMAKE_CXX_COMPILER_ID}")
        set(COMPILER_TYPE "UNKNOWN")
    endif()
endif()

# Output directories
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# Platform detection
if(WIN32)
    add_definitions(-D_WIN32_WINNT=0x0601)  # Windows 7+
    add_definitions(-DWIN32_LEAN_AND_MEAN)
    add_definitions(-DNOMINMAX)
endif()

# Compiler flags FIRST (before finding packages)
if(COMPILER_TYPE STREQUAL "MSVC")
    # MSVC-specific flags
    add_compile_options(
        /W4                    # Warning level 4
        /WX-                   # Don't treat warnings as errors (for now)
        /permissive-          # Standards conformance
        /Zc:__cplusplus       # Enable updated __cplusplus macro
        /EHsc                 # Exception handling model
        /MP                   # Multi-processor compilation
        /bigobj               # Large object files
    )
    add_definitions(-D_CRT_SECURE_NO_WARNINGS)
    add_definitions(-D_SCL_SECURE_NO_WARNINGS)
elseif(COMPILER_TYPE STREQUAL "CLANG" OR COMPILER_TYPE STREQUAL "MINGW")
    # Clang/MinGW flags (GCC-compatible)
    add_compile_options(
        -Wall                  # Enable all warnings
        -Wextra               # Extra warnings
        -Wno-unused-parameter # Suppress unused parameter
        -std=c++17            # C++17 standard
        -O2                   # Optimization level 2
    )
    if(WIN32)
        add_definitions(-DWIN32_LEAN_AND_MEAN)
        add_definitions(-DNOMINMAX)
    endif()
endif()

# For MSYS2 build, try to find dependencies (may not all be installed)
find_package(Boost QUIET COMPONENTS context system container)
find_package(OpenSSL QUIET)
find_package(Libevent QUIET)

# If dependencies not found, add include paths manually for MSYS2
if(NOT Boost_FOUND AND WIN32 AND COMPILER_TYPE MATCHES "MINGW|CLANG")
    message(STATUS "Boost not found via find_package, trying MSYS2 paths")
    set(BOOST_ROOT "C:/msys64/mingw64")
    set(Boost_INCLUDE_DIR "${BOOST_ROOT}/include")
    message(STATUS "Boost include: ${Boost_INCLUDE_DIR}")
endif()

if(NOT OPENSSL_FOUND AND WIN32 AND COMPILER_TYPE MATCHES "MINGW|CLANG")
    message(STATUS "OpenSSL not found via find_package, trying MSYS2 paths")
    set(OPENSSL_ROOT_DIR "C:/msys64/mingw64")
    set(OPENSSL_INCLUDE_DIR "${OPENSSL_ROOT_DIR}/include")
    set(OPENSSL_LIBRARIES "${OPENSSL_ROOT_DIR}/lib/libssl.a;${OPENSSL_ROOT_DIR}/lib/libcrypto.a")
    message(STATUS "OpenSSL include: ${OPENSSL_INCLUDE_DIR}")
endif()

if(NOT LIBEVENT_FOUND AND WIN32 AND COMPILER_TYPE MATCHES "MINGW|CLANG")
    message(STATUS "Libevent not found via find_package, trying MSYS2 paths")
    set(LIBEVENT_ROOT_DIR "C:/msys64/mingw64")
    set(LIBEVENT_INCLUDE_DIRS "${LIBEVENT_ROOT_DIR}/include")
    set(LIBEVENT_LIBRARIES "${LIBEVENT_ROOT_DIR}/lib/libevent.a")
    message(STATUS "Libevent include: ${LIBEVENT_INCLUDE_DIRS}")
endif()

# Include directories
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}
)

if(Boost_FOUND OR BOOST_ROOT)
    include_directories(${Boost_INCLUDE_DIR})
    message(STATUS "Boost found")
else()
    message(WARNING "Boost not found - continuing without it")
endif()

if(OPENSSL_FOUND OR OPENSSL_INCLUDE_DIR)
    include_directories(${OPENSSL_INCLUDE_DIR})
    message(STATUS "OpenSSL found")
else()
    message(WARNING "OpenSSL not found - continuing without it")
endif()

if(LIBEVENT_FOUND OR LIBEVENT_INCLUDE_DIRS)
    include_directories(${LIBEVENT_INCLUDE_DIRS})
    message(STATUS "Libevent found")
else()
    message(WARNING "Libevent not found - continuing without it")
endif()

# Source files
set(PDNS_RECURSOR_SOURCES
    dnsname.cc
    # dnsparser.cc  # Commented out for now - will enable incrementally
    # dnswriter.cc
    # qtype.cc
    # misc.cc
)

# Main executable (test compilation)
add_library(pdns_core STATIC ${PDNS_RECURSOR_SOURCES})

# Link libraries (only if found)
if(Boost_FOUND)
    target_link_libraries(pdns_core PRIVATE
        Boost::context
        Boost::system
        Boost::container
    )
elseif(BOOST_ROOT)
    # Try to link with direct paths
    message(STATUS "Linking with Boost via direct paths")
endif()

if(OPENSSL_FOUND)
    target_link_libraries(pdns_core PRIVATE
        OpenSSL::SSL
        OpenSSL::Crypto
    )
elseif(OPENSSL_LIBRARIES)
    target_link_libraries(pdns_core PRIVATE ${OPENSSL_LIBRARIES})
endif()

if(LIBEVENT_FOUND)
    target_link_libraries(pdns_core PRIVATE
        libevent::core
        libevent::extra
    )
elseif(LIBEVENT_LIBRARIES)
    target_link_libraries(pdns_core PRIVATE ${LIBEVENT_LIBRARIES})
endif()

# Windows libraries
target_link_libraries(pdns_core PRIVATE
    ws2_32      # Windows sockets
    iphlpapi    # IP Helper API
)

# Installation rules
# install(TARGETS pdns_recursor RUNTIME DESTINATION bin)

message(STATUS "PowerDNS Recursor Windows Port - CMake Configuration")
message(STATUS "  Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  C++ Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
if(Boost_FOUND)
    message(STATUS "  Boost version: ${Boost_VERSION}")
endif()
if(OPENSSL_FOUND)
    message(STATUS "  OpenSSL version: ${OPENSSL_VERSION}")
endif()


